<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>TO OUR SHARED : SEARCH</title>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css?family=Mansalva|Nanum+Gothic|Nanum+Myeongjo|Noto+Sans+KR|Lora|East+Sea+Dokdo|Jua&display=swap" rel="stylesheet">

    <!-- ICON -->
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }


        .modal-cost, #travelRoute_wrap {
            top: 0;
            margin-top: 28px;
            padding-right: 127px;
            display: flex;
            flex-direction: row-reverse;
            width: 100%;
            position: absolute;
        }

        .modal-cost-area {
            width: 300px;
            height: 700px;
            border: 1px solid rgba(0, 0, 0, 0.6);
            background-color: #eee;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
        }

        .cost-header {
            cursor: default;
            width: 100%;
            height: 80px;
            padding: 10px;
            background-color: #e2e2e2;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;

        }

        .cost-header .chTitle {
            font-size: 23px;
            font-weight: 700;
        }

        .cost-header .chBody {
            font-size: 15px;
        }

        .cost-body {
            width: 100%;
            height: 100%px;
            padding: 0px 10px 10px;
            overflow: auto;
        }

        .costItem {
            cursor: default;
            padding: 10px 0 5px;
            border-bottom: 1px dashed rgba(0, 0, 0, 0.2);
        }

        .costItem-header span {
            font-size: 40px;
            font-family: 'East Sea Dokdo', cursive;
        }

        .costItem-body ul {
            padding: 0 5px 0 20px;
            list-style-type: circle;
        }

        .costItem-body li {
            font-size: 12px;
        }
    </style>

</head>

<body>
                        <div id="travelRoute_wrap">
                            <ul id="travelRoute" class="travelRoute"></ul>
                        </div>


<div class="btn btn-secondary" onclick="pushTravelRouteItem(&quot;이태원거리&quot;,&quot;&quot;,&quot;undefined&quot;,&quot;02-710-3321&quot;,&quot;http://place.map.kakao.com/10753713&quot;,&quot;126.99580922812&quot;,&quot;37.5345613066561&quot;)">여행경로에 추가</div>

    

    <script>
        
        
  class TravelRouteItem {
            constructor(place_name, road_address_name, address_name, phone, place_url, x, y) {
                this.place_name = place_name;
                this.road_address_name = road_address_name;
                this.address_name = address_name;
                this.phone = phone;
                this.place_url = place_url;
                this.x = x;
                this.y = y;

            }
            setRoute(place_name, road_address_name, address_name, phone, place_url, x, y) {

                this.place_name = place_name;
                this.road_address_name = road_address_name;
                this.address_name = address_name;
                this.phone = phone;
                this.place_url = place_url;
                this.x = x;
                this.y = y;

            }

        }

        var TravelRouteList = Array();

        function refreashTravelRoute() {

            var travelRouteUl = document.getElementById('travelRoute'),
                fragment = document.createDocumentFragment(),
                headerFragment = document.createDocumentFragment(),
                itemList = '',
                el, headerEl,totalCost = 0,
                pindexTmp;
            
             ;

            // costBody 모든 자식 노드 삭제
            while (travelRouteUl.hasChildNodes()) {
                travelRouteUl.removeChild(travelRouteUl.firstChild);
            }
            TravelRouteList.forEach(function(currentValue, pindex) {
                pindexTmp = pindex;
                console.info(pindex);
                console.info(currentValue);
                el = document.createElement('li'),
                    itemStr =

                    '<div class="costItem-header">' +
                    '   <div class="form-group">' +
                    '       <table><tr>' +
                    '           <td>' +
                    '               <input id="addCost_place_name_' + pindex + '" class="form-control form-control-sm" type="text" placeholder="장소 이름" value="' + currentValue.place_name + '"  style="width:140px;" />' +
                    '           </td>' +
                    '           <td>' +
                    '               <div class="btn btn-secondary btn-sm" onclick="setCostItemParentName(' + pindex + ')" >이름변경</div>' +
                    '           </td>' +
                    '           <td>' +
                    '               <div class="btn btn-danger btn-sm" onclick="removeCostItemParent(' + pindex + ')"> x </div>' +
                    '           </td>' +
                    '       </tr></table>' +
                    '   </div>' +
                    //'         <span># ' + (index + 1) + '일 째</span>' +
                    '</div>' +
                    '   <div class="costItem-body">' +
                    '       <ul>';



                itemStr +=
                    '           <li>' +
                    '               <select id="addCost_costType_' + pindex + '" class="form-control form-control-sm">' +
                    '                   <option value="식비">식비</option>' +
                    '                   <option value="교통비">교통비</option>' +
                    '                   <option value="숙박비">숙박비</option>' +
                    '                   <option value="기타">기타</option>' +
                    '               </select>' +
                    '               <input id="addCost_cost_' + pindex + '" class="form-control form-control-sm" type="number" placeholder="비용">' +
                    '               <input id="addCost_info_' + pindex + '" class="form-control form-control-sm" type="text" placeholder="비용 설명">' +
                    '               <div class="btn btn-secondary btn-sm" onclick="pushCostItemChild(' + pindex + ')">+</div>' +
                    '               <div class="btn btn-secondary btn-sm" onclick="popCostItemChild(' + pindex + ')">-</div>' +
                    '           </li>' +
                    '   </ul>' +
                    '</div>';
                el.innerHTML = itemStr;
                el.setAttribute("draggable", 'true');
                el.setAttribute("class", "travelPoint");
                


                var itemEl = el;

                fragment.appendChild(itemEl);

                travelRouteUl.appendChild(fragment);



            });

            // 나중에 지도의 travelroute에서 추가할 버튼
            el = document.createElement('div'),
                itemStr =

                '<div class="btn btn-secondary btn-sm" onclick="addCostItemParent(' + pindexTmp + ')">+</div>';

            el.innerHTML = itemStr;
            //            el.setAttribute("draggable", 'true');
            //            el.setAttribute("id", "travelPoint");
            el.setAttribute("class", "costItem");


            var itemEl = el;

            fragment.appendChild(itemEl);

            travelRouteUl.appendChild(fragment);

            //--------------------





        }

        function pushTravelRouteItem(place_name, road_address_name, address_name, phone, place_url, x, y) {
 
           TravelRouteList.push(new TravelRouteItem(place_name, road_address_name, address_name, phone, place_url, x, y));

            refreashTravelRoute();

        }


        function removeTravelRouteItem(index) {



            TravelRouteItem.slice(index,1);
            refreashTravelRoute();

        }




        function setTravelRouteItem(index,place_name, road_address_name, address_name, phone, place_url, x, y) {


            TravelRouteList[index].setRoute(place_name, road_address_name, address_name, phone, place_url, x, y);
            refreashTravelRoute();
        }


        function removeTravelRouteItemParent(pindex) {
            CostItemList.splice(pindex, 1);
            refreashTravelRoute();
        }



        
         var DragManager;
        function dragAndDropAction() {
            //DragManger에 요소 추가 (추후 드래그 앤드롭 액션 실행)
            DragManager = {
                travelRoutes: [],
                currentContainer: null,

                add: function (travelRoute) {
                    this.travelRoutes.push(travelRoute);
                },

                handleEvent: function (event) {
                    //console.info(event.target);
                    if (event.type == 'dragstart') {
                        console.info("dragstart");
                        var containers = this.travelRoutes.filter(function (container) {

                            return container.contains(event.target);
                        });

                        if (containers.length > 0) {
                            this.currentContainer = containers[0];
                            this.currentContainer.activate();
                        }
                    }

                    if (this.currentContainer !== null) {
                        this.currentContainer.handleEvent(event);
                        if (event.type == 'dragend') {
                            this.currentContainer.deactivate();
                            this.currentContainer = null;
                        }
                    }
                }

            };

            window.addEventListener('dragstart', DragManager);
            window.addEventListener('dragend', DragManager);

            function travelRoute(container, type) {
                this.element = container;
                this.type = type || 'swap';
                this.items = $('> li', this.element);
                this.draggingItem = null;

                DragManager.add(this);
            }

            travelRoute.prototype.contains = function (target) {
                //console.info(target);
                return $(this.element).find(target).length;
            }

            travelRoute.prototype.handleEvent = function (event) {
                // NOTE: We've bound `this` to the travelRoute object, not
                // the element the event was fired on.
                var $t = $(event.target);

                if (event.type == 'dragstart') {
                    this.draggingItem = event.target;
                    console.info(event.target);
                    //setdata에 최상위 LIdml HTML을 데이터로 보낸다
                    console.info("this.draggingItem");
                    console.info(this.draggingItem);
                    var tgtItem = this.draggingItem;
                    while (1) {
                        //if(data.id == "travelPoint")
                        console.info("tgtItem.tagName");
                        console.info(tgtItem.tagName);
                        if (tgtItem.tagName == "LI")
                            break;
                        tgtItem = tgtItem.parentNode;
                    }
                    console.info("전송할 태그" + tgtItem);

                    event.dataTransfer.setData('text/html', tgtItem.innerHTML);
                }

                if (event.type == 'dragover' && this.draggingItem != event.target) {

                    $t.addClass('js-active');
                    // Preventing the default action _enables_ drop. Because JS APIs.
                    if (event.preventDefault) {
                        event.preventDefault();
                    }
                    event.dataTransfer.dropEffect = 'move';
                }

                if (event.type == 'dragleave') {
                    $t.removeClass('js-active');
                }

                if (event.type == 'drop' && this.draggingItem != null) {
                    if (this.type == 'swap') {


                        // 최상단 LI태그를 탐색
                        var tgtItem = event.target;
                        while (1) {
                            //if(data.id == "travelPoint")
                            if (tgtItem.tagName == "LI")
                                break;
                            tgtItem = tgtItem.parentNode;
                        }

                        //최상단  LI로만 옮김.
                        this.draggingItem.innerHTML = tgtItem.innerHTML;
                        tgtItem.innerHTML = event.dataTransfer.getData('text/html');
                    } else if (this.type == 'reorder') {
                        console.info('reorder');
                        console.info(this.items.index(event.target));
                    }
                }

                if (event.type == 'dragend' || event.type == 'drop') {
                    this.items.removeClass('js-active');
                    this.draggingItem = null;
                }
            }

            travelRoute.prototype.activate = function () {
                for (var i = 0, j = this.items.length; i < j; i++) {
                    // Make sure `this` is always a travelRoute instead of the element the
                    // event was activated on.
                    this.items[i].addEventListener('dragenter', this.handleEvent.bind(this));
                    this.items[i].addEventListener('dragover', this.handleEvent.bind(this));
                    this.items[i].addEventListener('dragleave', this.handleEvent.bind(this));
                    this.items[i].addEventListener('drop', this.handleEvent.bind(this));
                }
            }

            travelRoute.prototype.deactivate = function () {
                this.draggingItem = null;
                for (var i = 0, j = this.items.length; i < j; i++) {
                    //this.items[i].removeEventListener('dragenter', this.handleEvent);
                    //this.items[i].removeEventListener('dragover', this.handleEvent);
                    //this.items[i].removeEventListener('dragleave', this.handleEvent);
                    //this.items[i].removeEventListener('drop', this.handleEvent);
                }
            }

            var travelRoutes = document.getElementsByClassName('travelRoute');

            for (var i = 0, j = travelRoutes.length; i < j; i++) {
                new travelRoute(travelRoutes[i], (i % 2 == 0) ? 'swap' : 'reorder');
            }

        }
        
        

    </script>
</body></html>